# Supabase 数据库配置

## 概述

本文档说明如何在 Supabase 中配置数据库，包括个人日程管理和团队项目管理两个版本。

---

## 版本一：个人日程管理（当前版本）

### 1. 创建 Supabase 项目

1. 访问 [Supabase](https://supabase.com) 并注册账户
2. 创建新项目，选择数据库区域
3. 等待项目创建完成

### 2. 配置数据库表

在 Supabase Dashboard 的 SQL Editor 中执行以下 SQL 命令：

```sql
-- 创建 schedules 表（包含状态字段）
CREATE TABLE schedules (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  date DATE NOT NULL,
  time TIME NOT NULL,
  description TEXT,
  status VARCHAR(20) DEFAULT 'pending',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建 RLS (Row Level Security) 策略
ALTER TABLE schedules ENABLE ROW LEVEL SECURITY;

-- 用户只能访问自己的日程
CREATE POLICY "Users can view their own schedules" ON schedules
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own schedules" ON schedules
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own schedules" ON schedules
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own schedules" ON schedules
  FOR DELETE USING (auth.uid() = user_id);

-- 添加索引优化性能
CREATE INDEX idx_schedules_user_id ON schedules(user_id);
CREATE INDEX idx_schedules_date_time ON schedules(date, time);
CREATE INDEX idx_schedules_status ON schedules(status);

-- 添加状态约束
ALTER TABLE schedules ADD CONSTRAINT check_status
  CHECK (status IN ('pending', 'in_progress', 'completed', 'cancelled'));
```

### 3. 配置认证

在 Supabase Dashboard 的 Authentication > Settings 中：

1. 启用 Email/Password 认证（默认已启用）
2. 配置邮件设置（可选，用于邮箱确认）

### 4. 获取 API 密钥

在 Supabase Dashboard 的 Project Settings > API 中：

1. 复制 **Project URL**
2. 复制 **anon public** 密钥

### 5. 更新配置文件

编辑 `supabase-config.js` 文件，将获取的信息填入：

```javascript
const SUPABASE_CONFIG = {
    url: 'YOUR_SUPABASE_URL',
    anonKey: 'YOUR_SUPABASE_ANON_KEY'
};
```

---

## 版本二：团队项目管理（目标版本）

### 实施前提

⚠️ **重要**：在执行团队版本之前，请确保：
1. 已阅读并理解 [TEAM_DATABASE_DESIGN.md](./TEAM_DATABASE_DESIGN.md)
2. 已阅读并理解 [TEAM_REQUIREMENTS_ANALYSIS.md](./TEAM_REQUIREMENTS_ANALYSIS.md)
3. 已阅读并理解 [MIGRATION_GUIDE.md](./MIGRATION_GUIDE.md)
4. 已备份现有个人数据

### 1. 创建团队相关表

```sql
-- ============================================
-- 团队管理表
-- ============================================

-- 1. teams 表（团队表）
CREATE TABLE teams (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  owner_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 2. team_members 表（团队成员表）
CREATE TABLE team_members (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  team_id BIGINT REFERENCES teams(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  role VARCHAR(50) DEFAULT 'member',
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(team_id, user_id)
);

-- 3. work_groups 表（工作组表）
CREATE TABLE work_groups (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  team_id BIGINT REFERENCES teams(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  leader_id UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 4. work_group_members 表（工作组成员表）
CREATE TABLE work_group_members (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  work_group_id BIGINT REFERENCES work_groups(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id),
  joined_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(work_group_id, user_id)
);
```

### 2. 创建任务相关表（升级现有表）

```sql
-- ============================================
-- 任务管理表（升级现有 schedules 表）
-- ============================================

-- 为现有 schedules 表添加团队字段
ALTER TABLE schedules ADD COLUMN IF NOT EXISTS team_id BIGINT REFERENCES teams(id) ON DELETE SET NULL;
ALTER TABLE schedules ADD COLUMN IF NOT EXISTS work_group_id BIGINT REFERENCES work_groups(id) ON DELETE SET NULL;
ALTER TABLE schedules ADD COLUMN IF NOT EXISTS priority VARCHAR(20) DEFAULT 'medium';
ALTER TABLE schedules ADD COLUMN IF NOT EXISTS created_by UUID REFERENCES auth.users(id);
ALTER TABLE schedules ADD COLUMN IF NOT EXISTS updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW();
ALTER TABLE schedules RENAME COLUMN date TO start_date;
ALTER TABLE schedules ADD COLUMN IF NOT EXISTS end_date DATE;
ALTER TABLE schedules DROP COLUMN IF EXISTS time;

-- 添加约束
ALTER TABLE schedules ADD CONSTRAINT valid_task_status
  CHECK (status IN ('pending', 'in_progress', 'completed', 'cancelled'));

ALTER TABLE schedules ADD CONSTRAINT valid_task_priority
  CHECK (priority IN ('low', 'medium', 'high'));
```

### 3. 创建工作子项表

```sql
-- ============================================
-- 工作子项管理表
-- ============================================

-- 5. tasks 表（如果 schedules 表已存在，跳过）
-- 注意：如果已存在 schedules 表，使用上面的 ALTER 语句

-- 6. work_items 表（工作子项表）
CREATE TABLE work_items (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  task_id BIGINT REFERENCES schedules(id) ON DELETE CASCADE,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  execution_order VARCHAR(20) NOT NULL DEFAULT 'parallel',
  sequence_number INTEGER DEFAULT 0,
  planned_start_time TIMESTAMP WITH TIME ZONE,
  duration_hours DECIMAL(5,2),
  planned_end_time TIMESTAMP WITH TIME ZONE,
  assignee_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  collaborators TEXT,
  objectives TEXT,
  status VARCHAR(20) DEFAULT 'pending',
  progress INTEGER DEFAULT 0,
  actual_start_time TIMESTAMP WITH TIME ZONE,
  actual_end_time TIMESTAMP WITH TIME ZONE,
  created_by UUID REFERENCES auth.users(id),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 7. work_item_status_history 表（工作子项状态历史表）
CREATE TABLE work_item_status_history (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  work_item_id BIGINT REFERENCES work_items(id) ON DELETE CASCADE,
  status VARCHAR(20) NOT NULL,
  progress INTEGER DEFAULT 0,
  changed_by UUID REFERENCES auth.users(id),
  changed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 8. task_comments 表（任务评论表）
CREATE TABLE task_comments (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  task_id BIGINT REFERENCES schedules(id) ON DELETE CASCADE,
  work_item_id BIGINT REFERENCES work_items(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id),
  content TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 4. 创建索引

```sql
-- ============================================
-- 索引创建
-- ============================================

-- teams 表索引
CREATE INDEX idx_teams_owner ON teams(owner_id);
CREATE INDEX idx_teams_created ON teams(created_at);

-- team_members 表索引
CREATE INDEX idx_team_members_team ON team_members(team_id);
CREATE INDEX idx_team_members_user ON team_members(user_id);
CREATE INDEX idx_team_members_role ON team_members(role);

-- work_groups 表索引
CREATE INDEX idx_work_groups_team ON work_groups(team_id);
CREATE INDEX idx_work_groups_leader ON work_groups(leader_id);

-- work_group_members 表索引
CREATE INDEX idx_work_group_members_group ON work_group_members(work_group_id);
CREATE INDEX idx_work_group_members_user ON work_group_members(user_id);

-- schedules/tasks 表索引
CREATE INDEX idx_tasks_team ON schedules(team_id);
CREATE INDEX idx_tasks_work_group ON schedules(work_group_id);
CREATE INDEX idx_tasks_status ON schedules(status);
CREATE INDEX idx_tasks_priority ON schedules(priority);
CREATE INDEX idx_tasks_dates ON schedules(start_date, end_date);

-- work_items 表索引
CREATE INDEX idx_work_items_task ON work_items(task_id);
CREATE INDEX idx_work_items_assignee ON work_items(assignee_id);
CREATE INDEX idx_work_items_status ON work_items(status);
CREATE INDEX idx_work_items_execution_order ON work_items(execution_order);
CREATE INDEX idx_work_items_sequence ON work_items(task_id, sequence_number);
CREATE INDEX idx_work_items_times ON work_items(planned_start_time, planned_end_time);

-- work_item_status_history 表索引
CREATE INDEX idx_status_history_item ON work_item_status_history(work_item_id);
CREATE INDEX idx_status_history_time ON work_item_status_history(changed_at);
```

### 5. 配置 RLS 策略

```sql
-- ============================================
-- 行级安全策略（RLS）
-- ============================================

-- teams 表 RLS
ALTER TABLE teams ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Team members can view their team" ON teams
  FOR SELECT USING (
    id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid()
    )
    OR owner_id = auth.uid()
  );

CREATE POLICY "Team members can update team" ON teams
  FOR UPDATE USING (
    id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
    )
    OR owner_id = auth.uid()
  );

CREATE POLICY "Only owner can delete team" ON teams
  FOR DELETE USING (owner_id = auth.uid());

-- team_members 表 RLS
ALTER TABLE team_members ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Team members can view members" ON team_members
  FOR SELECT USING (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Owners and admins can add members" ON team_members
  FOR INSERT WITH CHECK (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
    )
  );

CREATE POLICY "Only owners can remove members" ON team_members
  FOR DELETE USING (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid() AND role = 'owner'
    )
  );

-- work_groups 表 RLS
ALTER TABLE work_groups ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Team members can view work groups" ON work_groups
  FOR SELECT USING (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid()
    )
  );

CREATE POLICY "Owners and admins can create work groups" ON work_groups
  FOR INSERT WITH CHECK (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
    )
  );

CREATE POLICY "Owners and admins can update work groups" ON work_groups
  FOR UPDATE USING (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
    )
  );

-- schedules/tasks 表 RLS
ALTER TABLE schedules ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Team members can view tasks" ON schedules
  FOR SELECT USING (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid()
    )
    OR team_id IS NULL AND user_id = auth.uid()
  );

CREATE POLICY "Owners and admins can create tasks" ON schedules
  FOR INSERT WITH CHECK (
    (team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
    ) OR team_id IS NULL)
    AND user_id = auth.uid()
  );

CREATE POLICY "Work group members can update tasks" ON schedules
  FOR UPDATE USING (
    team_id IN (
      SELECT team_id FROM team_members 
      WHERE user_id = auth.uid()
    )
    OR team_id IS NULL AND user_id = auth.uid()
  );

CREATE POLICY "Users can delete their own tasks" ON schedules
  FOR DELETE USING (user_id = auth.uid());

-- work_items 表 RLS
ALTER TABLE work_items ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Team members can view work items" ON work_items
  FOR SELECT USING (
    task_id IN (
      SELECT id FROM schedules 
      WHERE team_id IN (
        SELECT team_id FROM team_members 
        WHERE user_id = auth.uid()
      )
    )
  );

CREATE POLICY "Assignees can update work items" ON work_items
  FOR UPDATE USING (
    assignee_id = auth.uid()
    OR task_id IN (
      SELECT id FROM schedules 
      WHERE team_id IN (
        SELECT team_id FROM team_members 
        WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
      )
    )
  );

CREATE POLICY "Owners and admins can create work items" ON work_items
  FOR INSERT WITH CHECK (
    task_id IN (
      SELECT id FROM schedules 
      WHERE team_id IN (
        SELECT team_id FROM team_members 
        WHERE user_id = auth.uid() AND role IN ('owner', 'admin')
      )
    )
    AND created_by = auth.uid()
  );
```

### 6. 创建触发器

```sql
-- ============================================
-- 自动更新 updated_at 字段
-- ============================================

CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_schedules_updated_at 
BEFORE UPDATE ON schedules 
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_work_items_updated_at 
BEFORE UPDATE ON work_items 
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 7. 数据完整性约束

```sql
-- ============================================
-- 数据完整性约束
-- ============================================

-- 确保collaborators是有效的JSON格式
ALTER TABLE work_items 
  ADD CONSTRAINT valid_collaborators_json 
  CHECK (collaborators IS NULL OR jsonb_typeof(collaborators::jsonb) = 'array');

-- 确保progress在0-100之间
ALTER TABLE work_items 
  ADD CONSTRAINT valid_progress_range 
  CHECK (progress >= 0 AND progress <= 100);

-- 确保execution_order是有效值
ALTER TABLE work_items 
  ADD CONSTRAINT valid_execution_order 
  CHECK (execution_order IN ('parallel', 'sequential'));

-- 确保duration_hours为正数
ALTER TABLE work_items 
  ADD CONSTRAINT valid_duration 
  CHECK (duration_hours IS NULL OR duration_hours > 0);

-- 确保team_members的role是有效值
ALTER TABLE team_members 
  ADD CONSTRAINT valid_member_role 
  CHECK (role IN ('owner', 'admin', 'member'));

-- 确保work_items的status是有效值
ALTER TABLE work_items 
  ADD CONSTRAINT valid_work_item_status 
  CHECK (status IN ('pending', 'in_progress', 'completed', 'cancelled', 'blocked'));
```

---

## 数据迁移

### 迁移现有数据到团队结构

```sql
-- 为现有用户创建默认个人团队
INSERT INTO teams (name, owner_id, description)
SELECT 
  '个人团队' as name,
  user_id as owner_id,
  '从个人日程迁移的默认团队' as description
FROM schedules
WHERE team_id IS NULL
GROUP BY user_id
ON CONFLICT DO NOTHING;

-- 创建个人工作组
INSERT INTO work_groups (team_id, name, description, leader_id)
SELECT 
  t.id as team_id,
  '默认工作组' as name,
  '个人工作默认组' as description,
  t.owner_id as leader_id
FROM teams t
WHERE t.name = '个人团队'
AND NOT EXISTS (
  SELECT 1 FROM work_groups 
  WHERE team_id = t.id AND name = '默认工作组'
);

-- 迁移现有schedules到团队结构
UPDATE schedules
SET 
  team_id = (SELECT id FROM teams WHERE owner_id = user_id AND name = '个人团队' LIMIT 1),
  work_group_id = (SELECT id FROM work_groups WHERE team_id = (SELECT id FROM teams WHERE owner_id = user_id AND name = '个人团队' LIMIT 1) AND name = '默认工作组' LIMIT 1),
  created_by = user_id
WHERE team_id IS NULL;

-- 为每个现有任务创建一个默认工作子项
INSERT INTO work_items (
  task_id, title, description, execution_order, 
  planned_start_time, assignee_id, created_by, created_at
)
SELECT 
  s.id as task_id,
  s.title,
  s.description,
  'parallel' as execution_order,
  CONCAT(s.start_date, ' ', '09:00')::timestamp as planned_start_time,
  s.user_id as assignee_id,
  s.user_id as created_by,
  s.created_at
FROM schedules s
WHERE s.team_id IS NOT NULL
AND NOT EXISTS (
  SELECT 1 FROM work_items WHERE task_id = s.id
);
```

---

## 测试连接

### 个人版本测试

1. 启动应用后点击"注册"按钮创建新用户
2. 检查邮箱确认账户（如果启用了邮箱确认）
3. 登录后即可使用日程管理功能

### 团队版本测试

1. 创建一个团队
2. 邀请成员加入团队
3. 创建工作组和分配成员
4. 创建任务并分配到工作组
5. 添加工作子项并设置执行顺序
6. 查看自动生成的工作清单
7. 查看人员统计数据

---

## 安全注意事项

- ✅ 已启用 RLS (Row Level Security)
- ✅ 用户只能访问自己的数据
- ✅ 团队数据隔离（只有团队成员可以访问）
- ✅ 所有数据库操作都验证用户身份
- ✅ 敏感信息（API 密钥）已配置在单独文件中

---

## 版本选择

### 使用个人版本

如果您只需要个人日程管理：
1. 执行"版本一：个人日程管理"的SQL脚本
2. 配置 Supabase 连接
3. 开始使用

### 升级到团队版本

如果您需要团队协作功能：
1. ⚠️ **先备份现有数据**
2. 执行"版本二：团队项目管理"的所有SQL脚本
3. 配置 Supabase 连接
4. 等待前端功能实施完成
5. 开始使用

---

## 常见问题

### Q1: 如何从个人版本迁移到团队版本？
A: 请参考 [MIGRATION_GUIDE.md](./MIGRATION_GUIDE.md) 获取详细步骤。

### Q2: 迁移会丢失现有数据吗？
A: 不会，迁移脚本会保留所有现有数据，并创建对应的团队结构。

### Q3: 可以同时使用个人和团队版本吗？
A: 可以，系统支持个人任务和团队任务共存。

### Q4: 如何确保数据安全？
A: 通过 RLS 策略和完整的权限控制系统确保数据安全。

---

## 需要帮助？

如需更多帮助，请参考：
- [README.md](./README.md) - 项目总体说明
- [TEAM_DATABASE_DESIGN.md](./TEAM_DATABASE_DESIGN.md) - 详细的数据库设计
- [TEAM_REQUIREMENTS_ANALYSIS.md](./TEAM_REQUIREMENTS_ANALYSIS.md) - 需求分析
- [MIGRATION_GUIDE.md](./MIGRATION_GUIDE.md) - 迁移指南

---

## 🚀 团队版本数据库配置 (Team Version)

如果你打算启用团队协作功能，请按照以下步骤操作：

### 步骤一：执行完整的团队版数据库脚本

**重要**：使用项目中的完整 SQL 脚本，它包含所有必要的配置。
在 Supabase SQL Editor 中运行 `docs/sql/TEAM_VERSION_SETUP.sql` 文件的完整内容。该脚本将创建：

**表结构**（8 个核心表）：
- `teams` / `team_members` (团队与成员管理)
- `work_groups` / `work_group_members` (工作组管理) ⭐
- `tasks` / `work_items` (任务与工作子项体系)
- `work_item_status_history` (状态历史)
- `task_comments` (评论)

**完整配置**：
- ✅ 所有表的完整结构
- ✅ 索引优化
- ✅ 数据完整性约束
- ✅ 自动更新触发器
- ✅ **完整的 RLS 安全策略**（包括所有表的 SELECT、INSERT、UPDATE、DELETE 策略）

**重要提示**：
- ✅ 不需要删除 `schedules` 表（个人功能和团队功能可以共存）
- ✅ SQL 脚本使用 `CREATE TABLE IF NOT EXISTS`，不会覆盖现有表
- ✅ 脚本包含 `work_group_members` 表的完整 RLS 策略

### 步骤二：验证配置

执行完成后：
1. 在 Table Editor 中确认所有表已创建
2. 确认所有表都显示地球图标（🌐），没有 "UNRESTRICTED" 标签
3. 执行策略查询 SQL 确认所有表都有正确的策略数量

### 步骤三：数据平滑迁移 (可选)
如果你已经在使用个人版，并希望保留之前的日程数据，请运行 `docs/sql/MIGRATION_EXECUTE.sql`。
它会自动：
1. 为每个用户创建一个“个人团队”。
2. 将旧的 `schedules` 记录转换为新的 `tasks` 和 `work_items` 结构。
